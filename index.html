<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retirement Planner Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{ font-family:'Inter',sans-serif; }
    .backdrop{ background:linear-gradient(135deg,#6366f1,#a855f7); min-height:100%; }
    .glass{ backdrop-filter:blur(16px); background:rgba(255,255,255,.85); border:1px solid rgba(255,255,255,.4); }
    .btn{ @apply px-3 py-2 rounded-lg font-medium transition; }
    .btn-primary{ @apply bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95; }
    .btn-secondary{ @apply bg-white/70 text-slate-800 border border-slate-200 hover:bg-white active:scale-95; }
    .label{ @apply text-xs font-semibold text-slate-600 uppercase tracking-wide; }
    .input{ @apply w-full px-3 py-2 rounded-lg border border-slate-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300; }
    .summary-card{ @apply glass rounded-2xl p-4 flex flex-col items-start shadow-lg; }
    .summary-value{ @apply text-2xl font-extrabold text-slate-900; }
    .summary-label{ @apply text-xs text-slate-600; }
    .chip{ @apply text-[11px] px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200; }
    .table-head{ position:sticky; top:0; background:rgba(255,255,255,.95); backdrop-filter: blur(8px); box-shadow:0 1px 0 rgba(2,6,23,.06); }
  </style>
</head>
<body class="backdrop text-slate-900">
  <div class="max-w-7xl mx-auto p-6 space-y-6">

    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-4xl font-extrabold text-white">Retirement Planner Dashboard</h1>
        <p class="text-sm text-indigo-100 mt-1">Visualize your path to retirement. Adjust numbers, compare scenarios, and plan with clarity. Autosaves to your browser.</p>
      </div>
      <div class="flex gap-2">
        <button id="btnExportJSON" class="btn btn-secondary">Export</button>
        <label class="btn btn-secondary cursor-pointer">Import<input id="fileImport" type="file" accept="application/json" class="hidden"/></label>
        <button id="btnReset" class="btn btn-primary">Reset</button>
      </div>
    </header>

    <!-- Summary Widgets -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="summary-card"><div class="summary-value" id="summaryRetireAge">–</div><div class="summary-label">Earliest Retirement Age (4% ≥ spend)</div></div>
      <div class="summary-card"><div class="summary-value" id="summaryBal67">–</div><div class="summary-label">Highest End Balance @67</div></div>
      <div class="summary-card"><div class="summary-value" id="summaryBal90">–</div><div class="summary-label">Highest End Balance @90</div></div>
      <div class="summary-card"><div class="summary-value" id="summaryFourPct">–</div><div class="summary-label">Scenario hitting 4% first</div></div>
    </section>

    <!-- Inputs -->
    <section class="glass rounded-3xl p-6">
      <h2 class="text-lg font-semibold mb-3">Inputs</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div><div class="label">Current Age</div><input id="currentAge" type="number" class="input"></div>
        <div><div class="label">End Age</div><input id="endAge" type="number" class="input"></div>
        <div><div class="label">Current Balance ($)</div><input id="currentBalance" type="number" step="0.01" class="input"></div>
        <div><div class="label">Settlement Amount ($)</div><input id="settlementAmount" type="number" class="input"></div>
        <div><div class="label">Settlement Age</div><input id="settlementAge" type="number" class="input"></div>
        <div><div class="label">Annual Spend (today $)</div><input id="annualSpendToday" type="number" class="input"></div>
        <div><div class="label">Pre‑Ret Return (0‑1)</div><input id="preReturn" type="number" step="0.001" class="input"></div>
        <div><div class="label">Post‑Ret Return (0‑1)</div><input id="postReturn" type="number" step="0.001" class="input"></div>
        <div><div class="label">Inflation (0‑1)</div><input id="inflation" type="number" step="0.001" class="input"></div>
        <div><div class="label">SS Start Age</div><input id="ssStartAge" type="number" class="input"></div>
        <div><div class="label">SS Household (today $)</div><input id="ssHouseholdToday" type="number" class="input"></div>
        <div><div class="label">Mortgage Annual ($/yr)</div><input id="mortgageAnnual" type="number" step="0.01" class="input"></div>
        <div><div class="label">Mortgage End Age</div><input id="mortgageEndAge" type="number" class="input"></div>
      </div>
    </section>

    <!-- Scenarios -->
    <section class="glass rounded-3xl p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Scenarios</h2>
        <button id="btnAddScenario" class="btn btn-primary">+ Add Scenario</button>
      </div>
      <div id="scenariosWrap" class="space-y-3"></div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="glass rounded-3xl p-6">
        <h3 class="font-semibold mb-2">End Balance by Age</h3>
        <canvas id="balChart" height="320"></canvas>
      </div>
      <div class="glass rounded-3xl p-6">
        <h3 class="font-semibold mb-2">4% Income vs. Spending</h3>
        <canvas id="fourChart" height="320"></canvas>
      </div>
    </section>

    <!-- Tables -->
    <section id="tables" class="space-y-6"></section>

    <footer class="text-xs text-white/90">Your data saves to this browser (localStorage). Export/Import to move it.</footer>
  </div>

<script>
(function(){
  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const fmt$ = (n) => isFinite(n) ? n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}) : '–';
  const clone = (x) => JSON.parse(JSON.stringify(x));

  // ---------- Defaults (pre‑loaded with your numbers) ----------
  const DEFAULT_INPUTS = {
    currentAge: 43,
    endAge: 95,
    currentBalance: 551979.24,
    settlementAmount: 150000,
    settlementAge: 44,
    annualSpendToday: 70000,
    preReturn: 0.07,
    postReturn: 0.06,
    inflation: 0.03,
    ssStartAge: 67,
    ssHouseholdToday: 65000,
    mortgageAnnual: 896.81*12,
    mortgageEndAge: 53,
  };
  const DEFAULT_SCENARIOS = [
    { id: 'A', name: 'A: Retire ASAP', retireAge: 50, monthlyContrib: 4500, businessIncome: 0, payoffMortgageWithSettlement: false },
    { id: 'B', name: 'B: Balanced', retireAge: 55, monthlyContrib: 4500, businessIncome: 12000, payoffMortgageWithSettlement: false },
    { id: 'C', name: 'C: More Comfort', retireAge: 56, monthlyContrib: 3000, businessIncome: 0, payoffMortgageWithSettlement: false },
  ];

  // ---------- State ----------
  let inputs = clone(DEFAULT_INPUTS);
  let scenarios = clone(DEFAULT_SCENARIOS);
  const SAVED = localStorage.getItem('retirePlanner_v1');
  if (SAVED){ try{ const parsed = JSON.parse(SAVED); if(parsed.inputs && parsed.scenarios){ inputs = parsed.inputs; scenarios = parsed.scenarios; } }catch(e){} }

  // ---------- Bind Inputs ----------
  const bindInput = (id, key) => { const el = $('#'+id); el.value = inputs[key]; el.addEventListener('input', ()=>{ inputs[key] = parseFloat(el.value); rerender(); save(); }); };
  ['currentAge','endAge','currentBalance','settlementAmount','settlementAge','annualSpendToday','preReturn','postReturn','inflation','ssStartAge','ssHouseholdToday','mortgageAnnual','mortgageEndAge'].forEach(k=> bindInput(k,k));

  $('#btnReset').addEventListener('click', ()=>{ inputs = clone(DEFAULT_INPUTS); scenarios = clone(DEFAULT_SCENARIOS); hydrateInputs(); rerender(); save(); });
  $('#btnAddScenario').addEventListener('click', ()=>{ const n=scenarios.length+1; scenarios.push({ id:String.fromCharCode(64+n), name:`Scenario ${n}`, retireAge: inputs.currentAge+10, monthlyContrib: 4000, businessIncome: 0, payoffMortgageWithSettlement:false }); rerender(); save(); });
  $('#btnExportJSON').addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify({inputs,scenarios},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='retirement_planner_settings.json'; a.click(); URL.revokeObjectURL(url); });
  $('#fileImport').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(d.inputs&&d.scenarios){ inputs=d.inputs; scenarios=d.scenarios; hydrateInputs(); rerender(); save(); } }catch{ alert('Invalid JSON'); } }; r.readAsText(f); });

  function hydrateInputs(){ Object.entries(inputs).forEach(([k,v])=>{ const el=document.getElementById(k); if(el) el.value=v; }); }
  function save(){ localStorage.setItem('retirePlanner_v1', JSON.stringify({inputs,scenarios})); }

  // ---------- Scenario Editor ----------
  function renderScenarioEditors(){
    const wrap = document.getElementById('scenariosWrap'); wrap.innerHTML='';
    scenarios.forEach((s, idx)=>{
      const row = document.createElement('div');
      row.className = 'grid grid-cols-1 md:grid-cols-6 gap-3 items-end p-4 rounded-2xl bg-white/80 border border-white/60';
      row.innerHTML = `
        <div class="md:col-span-2"><div class="label mb-1">Name</div><input class="input" value="${s.name}"></div>
        <div><div class="label mb-1">Retire Age</div><input class="input" type="number" value="${s.retireAge}"></div>
        <div><div class="label mb-1">Monthly Contrib ($)</div><input class="input" type="number" value="${s.monthlyContrib}"></div>
        <div><div class="label mb-1">Business Income ($/yr)</div><input class="input" type="number" value="${s.businessIncome}"></div>
        <div><div class="label mb-1">Payoff Mortgage w/ Settlement?</div><select class="input"><option value="false" ${!s.payoffMortgageWithSettlement?'selected':''}>No</option><option value="true" ${s.payoffMortgageWithSettlement?'selected':''}>Yes</option></select></div>
        <div class="flex gap-2 md:justify-end"><button class="btn btn-secondary" data-act="dup">Duplicate</button><button class="btn btn-secondary" data-act="del">Delete</button></div>
        <div class="md:col-span-6 text-sm text-slate-700 mt-1">4% ≥ spend at: <strong data-out="first"></strong> • End bal @67: <strong data-out="b67"></strong> • End bal @90: <strong data-out="b90"></strong></div>`;
      const [nameEl, retireEl, contribEl, bizEl, payoffSel] = [0,1,2,3,4].map(i=> row.querySelectorAll('input,select')[i]);
      nameEl.addEventListener('input', ()=>{ s.name=nameEl.value; rerender(); save(); });
      retireEl.addEventListener('input', ()=>{ s.retireAge=parseInt(retireEl.value||'0'); rerender(); save(); });
      contribEl.addEventListener('input', ()=>{ s.monthlyContrib=parseFloat(contribEl.value||'0'); rerender(); save(); });
      bizEl.addEventListener('input', ()=>{ s.businessIncome=parseFloat(bizEl.value||'0'); rerender(); save(); });
      payoffSel.addEventListener('change', ()=>{ s.payoffMortgageWithSettlement = payoffSel.value==='true'; rerender(); save(); });
      row.querySelector('[data-act="dup"]').addEventListener('click', ()=>{ const copy=clone(s); copy.id=String.fromCharCode(65+scenarios.length); copy.name=s.name+' (copy)'; scenarios.push(copy); rerender(); save(); });
      row.querySelector('[data-act="del"]').addEventListener('click', ()=>{ scenarios.splice(idx,1); rerender(); save(); });
      wrap.appendChild(row);
    });
  }

  // ---------- Simulator ----------
  function simulateScenario(s){
    const rows=[]; let endBalPrev=inputs.currentBalance;
    for(let age=inputs.currentAge; age<=inputs.endAge; age++){
      const yearsFromToday=age-inputs.currentAge; const retired=age>=s.retireAge;
      const startBal=endBalPrev; const contrib=!retired ? s.monthlyContrib*12 : 0; const settlement=age===inputs.settlementAge?inputs.settlementAmount:0;
      const spendInfl=inputs.annualSpendToday*Math.pow(1+inputs.inflation, yearsFromToday); const ssInfl=inputs.ssHouseholdToday*Math.pow(1+inputs.inflation, yearsFromToday);
      let mortgageAdd=0; const mortgageActive=age<inputs.mortgageEndAge; if(mortgageActive){ mortgageAdd = (s.payoffMortgageWithSettlement && age>=inputs.settlementAge)?0:inputs.mortgageAnnual; }
      const bizIncome=(retired && age<inputs.ssStartAge)?s.businessIncome:0; const socialSec=(age>=inputs.ssStartAge)?ssInfl:0;
      const appliedReturn = !retired ? inputs.preReturn : inputs.postReturn; const investReturn=(startBal+contrib+settlement)*appliedReturn;
      const need=spendInfl+mortgageAdd-bizIncome-socialSec; const netWithdrawal = retired ? Math.max(0, need) : 0;
      const endBal=startBal+contrib+settlement+investReturn-netWithdrawal; const fourPct=endBal*0.04;
      rows.push({ age,startBal,contrib,settlement,spendInfl,mortgageAdd,bizIncome,socialSec,investReturn,netWithdrawal,endBal,fourPct }); endBalPrev=endBal;
    }
    let firstAgeFourPct=null; for(const r of rows){ if(r.fourPct>=r.spendInfl){ firstAgeFourPct=r.age; break; } }
    const endAt67=(rows.find(r=>r.age===67)||{}).endBal; const endAt90=(rows.find(r=>r.age===90)||{}).endBal; return { rows, firstAgeFourPct, endAt67, endAt90 };
  }

  function runAll(){ return scenarios.map(s=> ({ s, sim: simulateScenario(s) })); }

  // ---------- Charts ----------
  let balChart, fourChart; function palette(i){ const hues=[255,200,160,120,30,330]; const h=hues[i%hues.length]; return { border:`hsl(${h} 80% 48%)`, fill:`hsla(${h},80%,48%,.12)` }; }
  function renderCharts(sims){
    const ages=sims[0]?.sim.rows.map(r=>r.age)||[]; const spendSeries=sims[0]?.sim.rows.map(r=>r.spendInfl)||[];
    const datasetsBal=sims.map((x,i)=>{ const c=palette(i); return { label:x.s.name+' – End Bal', data:x.sim.rows.map(r=>r.endBal), borderColor:c.border, backgroundColor:c.fill, tension:.25, pointRadius:0, borderWidth:3, fill:true }; });
    if(balChart) balChart.destroy(); balChart=new Chart(document.getElementById('balChart'),{ type:'line', data:{ labels:ages, datasets:datasetsBal }, options:{ responsive:true, interaction:{mode:'index',intersect:false}, plugins:{ legend:{labels:{boxWidth:14,boxHeight:14}}, tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${fmt$(ctx.parsed.y)}`}} }, scales:{ y:{ ticks:{ callback:v=> '$'+(v/1_000_000).toFixed(1)+'M'} } } }});
    const datasetsFour=[ { label:'Spending (infl.)', data:spendSeries, borderDash:[6,6], borderWidth:3, tension:.25, pointRadius:0, fill:false, borderColor:'hsl(220 10% 30%)' } ].concat(
      sims.map((x,i)=>{ const c=palette(i); return { label:x.s.name+' – 4% income', data:x.sim.rows.map(r=>r.fourPct), borderColor:c.border, backgroundColor:c.fill, borderWidth:3, tension:.25, pointRadius:0 }; }) );
    if(fourChart) fourChart.destroy(); fourChart=new Chart(document.getElementById('fourChart'),{ type:'line', data:{ labels:ages, datasets:datasetsFour }, options:{ responsive:true, interaction:{mode:'index',intersect:false}, plugins:{ legend:{labels:{boxWidth:14,boxHeight:14}}, tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${fmt$(ctx.parsed.y)}`}} }, scales:{ y:{ ticks:{ callback:v=> fmt$(v) } } } }});
  }

  // ---------- Tables ----------
  function renderTables(sims){
    const root=document.getElementById('tables'); root.innerHTML='';
    sims.forEach(({s,sim})=>{
      const card=document.createElement('div'); card.className='glass rounded-3xl p-6';
      const head=document.createElement('div'); head.className='flex items-center justify-between mb-2';
      head.innerHTML=`<h3 class="font-semibold">${s.name}</h3><div class="text-sm text-slate-700">4% ≥ spend: <strong>${sim.firstAgeFourPct ?? '–'}</strong> • End bal @67: <strong>${fmt$(sim.endAt67)}</strong> • End bal @90: <strong>${fmt$(sim.endAt90)}</strong></div>`;
      const wrap=document.createElement('div'); wrap.className='overflow-auto max-h-[420px] rounded-2xl border border-white/60 bg-white/80';
      const headers=["Age","Start Bal","Contrib","Settlement","Spend (infl.)","Mortgage","Business","Social Sec","Return","Net Withdrawal","End Bal","4%"];
      let html='<table class="w-full text-sm">'; html+='<thead class="table-head"><tr>'+headers.map(h=>`<th class="text-left p-2">${h}</th>`).join('')+'</tr></thead><tbody>';
      html+=sim.rows.map(r=>`<tr class="border-b border-white/60">`+
        `<td class="p-2">${r.age}</td>`+
        `<td class="p-2">${fmt$(r.startBal)}</td>`+
        `<td class="p-2">${fmt$(r.contrib)}</td>`+
        `<td class="p-2">${fmt$(r.settlement)}</td>`+
        `<td class="p-2">${fmt$(r.spendInfl)}</td>`+
        `<td class="p-2">${fmt$(r.mortgageAdd)}</td>`+
        `<td class="p-2">${fmt$(r.bizIncome)}</td>`+
        `<td class="p-2">${fmt$(r.socialSec)}</td>`+
        `<td class="p-2">${fmt$(r.investReturn)}</td>`+
        `<td class="p-2">${fmt$(r.netWithdrawal)}</td>`+
        `<td class="p-2 font-semibold">${fmt$(r.endBal)}</td>`+
        `<td class="p-2">${fmt$(r.fourPct)}</td>`+
      `</tr>`).join(''); html+='</tbody></table>'; wrap.innerHTML=html; card.appendChild(head); card.appendChild(wrap); root.appendChild(card);
    });
  }

  // ---------- Summary Cards ----------
  function updateSummary(sims){
    // Earliest retirement age across scenarios
    const withAge = sims.map(x=>({name:x.s.name, age:x.sim.firstAgeFourPct})).filter(x=>x.age!=null);
    const earliest = withAge.sort((a,b)=>a.age-b.age)[0];
    $('#summaryRetireAge').textContent = earliest ? `${earliest.age}` : '–';
    $('#summaryFourPct').textContent = earliest ? earliest.name : '–';

    // Highest balances at 67 & 90
    const best67 = sims.map(x=>({name:x.s.name, v:x.sim.endAt67||-Infinity})).sort((a,b)=>b.v-a.v)[0];
    const best90 = sims.map(x=>({name:x.s.name, v:x.sim.endAt90||-Infinity})).sort((a,b)=>b.v-a.v)[0];
    $('#summaryBal67').textContent = best67 && isFinite(best67.v) ? fmt$(best67.v) : '–';
    $('#summaryBal90').textContent = best90 && isFinite(best90.v) ? fmt$(best90.v) : '–';
  }

  // ---------- Render ----------
  function rerender(){
    renderScenarioEditors();
    const sims = runAll();
    renderCharts(sims);
    renderTables(sims);
    updateSummary(sims);
  }

  // Boot
  function hydrateInputs(){ Object.entries(inputs).forEach(([k,v])=>{ const el=document.getElementById(k); if(el) el.value=v; }); }
  hydrateInputs();
  rerender();
})();
</script>
</body>
</html>